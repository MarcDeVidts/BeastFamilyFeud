<!DOCTYPE html>
<html>
  <head>
    <title>Beast Podium</title>
    <style>
      body {
        background-color: black;
        color: white;
        text-align: center;
        font-family: Arial, sans-serif;
      }
      button {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: none;
        font-size: 20px;
        margin: 20px;
        cursor: pointer;
        color: white;
      }
      .red-button {
        background-color: red;
      }
      .blue-button {
        background-color: blue;
      }
      .winner {
        border: 5px solid white;
      }
      .reset-button {
        width: 200px;
        height: 50px;
        border-radius: 10px;
        background-color: gray;
        font-size: 20px;
        color: white;
        cursor: pointer;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Beast Podium</h1>
    <div>
      <button
        id="button1"
        class="red-button"
        onclick="sendCommand('setWinner1')"
      >
        PLAYER 1
      </button>
      <button
        id="button2"
        class="blue-button"
        onclick="sendCommand('setWinner2')"
      >
        PLAYER 2
      </button>
    </div>
    <button class="reset-button" onclick="sendCommand('reset')">
      Reset to Idle
    </button>

    <div id="status">
      <h2>Machine State: <span id="machineState">Unknown</span></h2>
      <h2>Winner: <span id="winner">None</span></h2>
    </div>

    <script>
      var webSocket;
      var reconnectInterval;

      function initWebSocket() {
        console.log("Connecting WebSocket");
        webSocket = new WebSocket("ws://" + window.location.hostname + ":81/");

        webSocket.onopen = function (event) {
          console.log("WebSocket connection opened");
          clearInterval(reconnectInterval); // Clear any existing reconnect attempts
        };

        webSocket.onclose = function (event) {
          console.log("WebSocket connection closed");
          attemptReconnect();
        };

        webSocket.onmessage = function (event) {
          console.log("WebSocket message received:", event.data);
          handleWebSocketMessage(event.data);
        };
      }

      function attemptReconnect() {
        reconnectInterval = setInterval(function () {
          console.log("Attempting to reconnect WebSocket...");
          initWebSocket();
        }, 5000);
      }

      function sendCommand(command) {
        if (webSocket && webSocket.readyState === WebSocket.OPEN) {
          webSocket.send(command);
        } else {
          console.log("WebSocket is not connected");
        }
      }

      function handleWebSocketMessage(data) {
        var message = JSON.parse(data);
        var machineStateText = "";
        switch (message.machineState) {
          case 0:
            machineStateText = "IDLE";
            break;
          case 1:
            machineStateText = "VOTING";
            break;
        }
        document.getElementById("machineState").innerText = machineStateText;
        document.getElementById("winner").innerText = message.winner;
        document.getElementById("button1").classList.remove("winner");
        document.getElementById("button2").classList.remove("winner");
        if (message.winner == 1) {
          document.getElementById("button1").classList.add("winner");
        } else if (message.winner == 2) {
          document.getElementById("button2").classList.add("winner");
        }
      }

      window.onload = function () {
        initWebSocket();
      };
    </script>
  </body>
</html>
